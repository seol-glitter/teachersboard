<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교사용 대시보드</title>
<style>
:root{ --bg:#eaf6ff; --card:#fff; --ink:#0f172a; --sub:#334155; --pri:#0ea5e9; --priD:#0284c7; --warn:#ef4444; --ok:#16a34a; }
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:1000px;margin:0 auto;padding:18px}
h1{margin:0 0 10px}
.badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#e2fbe8;color:#065f46;font-weight:800;font-size:12px}
.badge.off{background:#fee2e2;color:#991b1b}
.card{background:var(--card);border:1px solid #d7e7f5;border-radius:16px;padding:16px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.row>*{flex:1}
input,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:12px}
textarea{min-height:160px}
.btn{padding:10px 14px;border:0;border-radius:12px;background:var(--pri);color:#fff;font-weight:800;cursor:pointer}
.btn:hover{background:var(--priD)}
.btn.sec{background:#475569}
.btn.warn{background:var(--warn)}
.note{font-size:12px;color:var(--sub);margin-top:6px}
.hide{display:none}
.grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
.thumb{background:#0f172a;border-radius:12px;overflow:hidden;color:#fff}
.thumb img{display:block;width:100%;height:140px;object-fit:cover}
.caption{padding:8px;font-size:12px}
.lock{padding:24px;border:2px dashed #fca5a5;background:#fff0f0;border-radius:16px;color:#991b1b;font-weight:700}
</style>
<body>
<div class="wrap">
  <h1>교사용 대시보드 <span id="bindState" class="badge">확인 중…</span></h1>

  <div id="lockPane" class="lock hide">
    이 기기는 <b>연결 해제 및 전체 삭제</b>가 수행되어 사용이 잠겨 있습니다.<br/>
    브라우저의 <b>사이트 데이터 전체 삭제</b>를 수행해야 다시 사용할 수 있습니다.
  </div>

  <div class="card" id="rebindCard">
    <h3>로그인(기관/학급/비밀번호)</h3>
    <div class="row">
      <input id="school" type="text" placeholder="기관명"/>
      <input id="klass"  type="text" placeholder="학급명"/>
      <input id="tcode"  type="password" placeholder="교사용 비밀번호"/>
    </div>
    <div class="row">
      <button class="btn" id="btnBind">로그인 & 연결</button>
    </div>
    <div class="note" id="bindMsg"></div>
  </div>

  <div id="main" class="hide">
    <!-- 유아명단 + 저장 -->
    <div class="card">
      <h3>유아 명단(한 줄에 한 명)</h3>
      <textarea id="roster" placeholder="예) 김하늘&#10;박도윤&#10;이서연"></textarea>
      <div class="row">
        <button class="btn" id="btnSaveRoster">유아명 저장</button>
        <button class="btn sec" id="btnLoadRoster">불러오기</button>
      </div>
      <div class="note" id="rosterMsg"></div>
    </div>

    <!-- 성취 보기(유아별 최신 1장/문항) -->
    <div class="card">
      <h3>유아 성취(최신)</h3>
      <div id="grid" class="grid"></div>
      <div class="note" id="achMsg"></div>
    </div>

    <!-- 학부모 공용코드 -->
    <div class="card">
      <h3>학부모 공용코드</h3>
      <div class="row">
        <input id="parentCode" type="text" placeholder="예: FIRE12"/>
        <button class="btn" id="btnSetPC">저장</button>
      </div>
      <div class="note">학부모 공용코드를 학부모에게 안내하면 <b>자녀의 성취 정보를 열람</b>할 수 있습니다. (학부모코드 = 공용코드 + 2자리 유아번호, 예: FIRE12<span style="text-decoration:underline">07</span>)</div>
      <div class="note" id="pcMsg"></div>
    </div>

    <!-- 비밀번호 변경 -->
    <div class="card">
      <h3>교사용 비밀번호 변경</h3>
      <div class="row">
        <input id="oldPw" type="password" placeholder="현재 비밀번호"/>
        <input id="newPw" type="password" placeholder="새 비밀번호"/>
        <button class="btn" id="btnChgPw">변경</button>
      </div>
      <div class="note" id="pwMsg"></div>
    </div>

    <!-- 연결 해제·삭제 -->
    <div class="card">
      <h3>연결 해제 및 삭제</h3>
      <div class="row">
        <button class="btn warn" id="btnUnbind">기기 연결 해제</button>
      </div>
      <div class="note">
        <b>기기 연결 해제</b> 버튼을 누르면 이 기기에 저장된 <b>모든 정보가 삭제</b>되며, 이 기기는 <b>사용이 잠금</b>됩니다.
      </div>
    </div>
  </div>
</div>

<script>
// ===== 설정 =====
const EXEC = '<<여기에 교사용(B 또는 A) 스크립트 배포 URL>>'; // JSONP 엔드포인트

// ===== JSONP 헬퍼 =====
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Date.now().toString(36)+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{ try{resolve(data)}finally{ delete window[cb]; s.remove(); } };
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback='+cb;
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error('network')); };
    document.body.appendChild(s);
  });
}
const $=id=>document.getElementById(id);

// ===== 락/연결 상태 =====
function setBindState(on){
  const b=$('bindState');
  if(on){ b.textContent='연결됨'; b.classList.remove('off'); }
  else { b.textContent='미연결'; b.classList.add('off'); }
}
function checkLock(){
  const locked=localStorage.getItem('__LOCK__')==='1';
  $('lockPane').classList.toggle('hide', !locked);
  $('rebindCard').classList.toggle('hide', locked);
  $('main').classList.add('hide');
  setBindState(false);
  return locked;
}
function refreshUI(){
  if(checkLock()) return false;
  const tk=(localStorage.getItem('tk')||'').trim();
  const on=!!tk;
  setBindState(on);
  $('rebindCard').classList.toggle('hide', on);
  $('main').classList.toggle('hide', !on);
  return on;
}

// ===== 기능 =====
async function bindNow(){
  if(checkLock()) return;
  $('bindMsg').textContent='연결 중…';
  const school=$('school').value.trim(), klass=$('klass').value.trim(), code=$('tcode').value.trim();
  if(!school||!klass||!code){ $('bindMsg').textContent='기관/학급/비밀번호를 모두 입력해주세요.'; return; }
  try{
    const j=await jsonp(`${EXEC}?`+new URLSearchParams({action:'key',schoolId:school,classId:klass,code:code}).toString());
    if(j&&j.ok&&j.teacherKey){
      localStorage.setItem('tk', j.teacherKey);
      localStorage.setItem('schoolId', school);
      localStorage.setItem('classId', klass);
      $('bindMsg').textContent='연결 성공';
      refreshUI(); loadRoster(); loadAchievements();
    }else{
      $('bindMsg').textContent='실패: '+(j&&j.error||'');
    }
  }catch(e){ $('bindMsg').textContent='네트워크 오류'; }
}

async function loadRoster(){
  $('rosterMsg').textContent='불러오는 중…';
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('rosterMsg').textContent='미연결'; return; }
  try{
    const j=await jsonp(`${EXEC}?action=resolveKey&key=${encodeURIComponent(tk)}`);
    if(j&&Array.isArray(j.roster)){ $('roster').value=j.roster.join('\n'); $('rosterMsg').textContent='완료'; }
    else{ $('roster').value=''; $('rosterMsg').textContent='명단 없음(저장 필요)'; }
  }catch(e){ $('rosterMsg').textContent='네트워크 오류'; }
}
async function saveRoster(){
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('rosterMsg').textContent='미연결'; return; }
  const roster=$('roster').value.trim(); if(!roster){ $('rosterMsg').textContent='명단이 비었습니다.'; return; }
  $('rosterMsg').textContent='저장 중…';
  try{
    const j=await jsonp(`${EXEC}?`+new URLSearchParams({action:'saveRoster',key:tk,roster}).toString());
    $('rosterMsg').textContent = j&&j.ok ? '저장 완료' : ('실패: '+(j&&j.error||''));
    if(j&&j.ok) loadAchievements();
  }catch(e){ $('rosterMsg').textContent='네트워크 오류'; }
}

async function loadAchievements(){
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('achMsg').textContent='미연결'; return; }
  $('achMsg').textContent='불러오는 중…'; $('grid').innerHTML='';
  try{
    const j=await jsonp(`${EXEC}?action=listByChild&key=${encodeURIComponent(tk)}`);
    if(!(j&&j.ok)){ $('achMsg').textContent='불러오기 실패'; return; }
    const items=j.items||[];
    // child+problem 최신만 그리드로 간단 표시
    const grid=$('grid'); grid.innerHTML='';
    for(const it of items){
      const card=document.createElement('div'); card.className='thumb';
      const img=document.createElement('img'); img.alt=it.problem;
      try{
        const t=await jsonp(`${EXEC}?action=thumbB64&fileId=${encodeURIComponent(it.fileId)}`);
        if(t&&t.ok&&t.b64) img.src=`data:${t.mime||'image/jpeg'};base64,${t.b64}`;
        else{ img.alt='(이미지 없음)'; img.style.height='140px'; }
      }catch(_){ img.alt='(로드 실패)'; img.style.height='140px'; }
      const cap=document.createElement('div'); cap.className='caption';
      cap.textContent=`${it.child} · ${it.problem}`;
      card.appendChild(img); card.appendChild(cap);
      grid.appendChild(card);
    }
    $('achMsg').textContent = items.length? '': '표시할 항목이 없습니다.';
  }catch(e){ $('achMsg').textContent='네트워크 오류'; }
}

async function setParentCode(){
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('pcMsg').textContent='미연결'; return; }
  const pc=$('parentCode').value.trim(); if(!pc){ $('pcMsg').textContent='공용코드를 입력하세요.'; return; }
  $('pcMsg').textContent='저장 중…';
  try{
    const j=await jsonp(`${EXEC}?`+new URLSearchParams({action:'setParentCode',key:tk,parentCode:pc}).toString());
    $('pcMsg').textContent = j&&j.ok ? '저장 완료' : '실패';
  }catch(e){ $('pcMsg').textContent='네트워크 오류'; }
}

async function changePw(){
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('pwMsg').textContent='미연결'; return; }
  const oldPw=$('oldPw').value.trim(), newPw=$('newPw').value.trim();
  if(!oldPw||!newPw){ $('pwMsg').textContent='입력 누락'; return; }
  $('pwMsg').textContent='변경 중…';
  try{
    const j=await jsonp(`${EXEC}?`+new URLSearchParams({action:'changeTeacherCode',key:tk,old:oldPw,new:newPw}).toString());
    $('pwMsg').textContent = j&&j.ok ? '변경 완료' : ('실패: '+(j&&j.error||'')); 
  }catch(e){ $('pwMsg').textContent='네트워크 오류'; }
}

function unbind(){
  try{ localStorage.clear(); }catch(e){}
  localStorage.setItem('__LOCK__','1'); // 하드락
  location.reload();
}

// 이벤트
$('btnBind').onclick=bindNow;
$('btnLoadRoster').onclick=loadRoster;
$('btnSaveRoster').onclick=saveRoster;
$('btnSetPC').onclick=setParentCode;
$('btnChgPw').onclick=changePw;
$('btnUnbind').onclick=unbind;

// 초기
if(refreshUI()){ loadRoster(); loadAchievements(); }
</script>
</body>
</html>
