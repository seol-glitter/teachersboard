<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교사용 대시보드</title>
<style>
:root{ --bg:#f6fbff; --primary:#0ea5e9; --danger:#ef4444; --ink:#0f172a; }
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg)}
.wrap{max-width:960px;margin:0 auto;padding:18px}
.card{background:#fff;border:1px solid #d7e7f5;border-radius:14px;padding:16px;margin:12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.row>*{flex:1}
h1{margin:0 0 8px}
h3{margin:0 0 10px}
input,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
textarea{min-height:160px}
.btn{padding:10px 14px;border:0;border-radius:10px;font-weight:800;cursor:pointer;color:#fff;background:var(--primary)}
.btn.secondary{background:#475569}
.btn.warn{background:var(--danger)}
.btn.outline{background:#fff;color:var(--ink);border:2px solid #92a3b5}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e2fbe8;color:#065f46;font-size:12px;font-weight:700}
.note{font-size:12px;color:#334155;margin-top:6px}
.err{color:#b91c1c}.ok{color:#065f46}
.hide{display:none}
</style>
<body>
<div class="wrap">
  <h1>교사용 대시보드 <span id="state" class="badge">상태 확인 중…</span></h1>

  <!-- 로그인/연결 -->
  <div class="card" id="bindCard">
    <h3>기기 연결(로그인)</h3>
    <div class="row">
      <input id="school" type="text" placeholder="기관명">
      <input id="klass"  type="text" placeholder="학급명">
      <input id="tcode"  type="password" placeholder="교사용 비밀번호">
    </div>
    <div class="row">
      <button class="btn" id="btnBind">로그인 & 연결</button>
    </div>
    <div class="note" id="bindMsg"></div>
  </div>

  <div id="main" class="hide">
    <!-- 명단 -->
    <div class="card">
      <h3>유아 명단(한 줄에 한 명)</h3>
      <textarea id="roster" placeholder="예) 김하늘&#10;박도윤&#10;이서연"></textarea>
      <div class="row">
        <button class="btn" id="btnSaveRoster">저장</button>
        <button class="btn secondary" id="btnLoadRoster">불러오기</button>
      </div>
      <div class="note" id="rosterMsg"></div>
    </div>

    <!-- 학부모 공용코드 -->
    <div class="card">
      <h3>학부모 공용코드</h3>
      <div class="row">
        <input id="parentCode" type="text" placeholder="예: FIRE12">
        <button class="btn" id="btnSetPC">저장</button>
      </div>
      <div class="note">학부모코드 = [공용코드]+[2자리 유아번호] 예) FIRE12<span style="text-decoration:underline">07</span></div>
      <div class="note" id="pcMsg"></div>
    </div>

    <!-- 비밀번호 변경 -->
    <div class="card">
      <h3>교사용 비밀번호 변경</h3>
      <div class="row">
        <input id="oldPw" type="password" placeholder="현재 비밀번호">
        <input id="newPw" type="password" placeholder="새 비밀번호">
        <button class="btn" id="btnChgPw">변경</button>
      </div>
      <div class="note" id="pwMsg"></div>
    </div>

    <!-- 연결 해제 -->
    <div class="card">
      <h3>연결 해제 및 삭제</h3>
      <div class="row">
        <button class="btn outline" id="btnUnbind">기기 연결 해제</button>
        <button class="btn warn" id="btnWipe">서버 데이터까지 완전 삭제(위험)</button>
      </div>
      <div class="note">
        • <b>기기 연결 해제</b>: 이 기기에 저장된 로그인 정보(tk)와 설정이 삭제됩니다. 서버의 학급 데이터는 유지됩니다.<br>
        • <b>완전 삭제</b>: 시트 기록·드라이브 폴더·설정까지 모두 삭제됩니다(되돌릴 수 없음).
      </div>
      <div class="note" id="wipeMsg"></div>
    </div>
  </div>
</div>

<script>
// === 설정 ===
const EXEC_URL = '<<여기에 B 또는 A 스크립트 URL 붙여넣기>>';

// === JSONP ===
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{ try{resolve(data);}finally{ delete window[cb]; s.remove(); } };
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback='+cb;
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error('network')); };
    document.body.appendChild(s);
  });
}
const $ = (id)=>document.getElementById(id);

// === 상태 표시/전환 ===
function tk(){ return (localStorage.getItem('tk')||'').trim(); }
function setState(ok){ const e=$('state'); if(ok){ e.textContent='연결됨'; e.style.background='#dcfce7'; e.style.color='#065f46'; } else { e.textContent='미연결'; e.style.background='#fee2e2'; e.style.color='#991b1b'; } }
function refresh(){
  const on = !!tk();
  setState(on); $('bindCard').classList.toggle('hide', on); $('main').classList.toggle('hide', !on);
}

// === 동작 ===
async function bindNow(){
  $('bindMsg').textContent='연결 중…';
  const school=$('school').value.trim(), klass=$('klass').value.trim(), code=$('tcode').value.trim();
  if(!school||!klass||!code){ $('bindMsg').textContent='기관/학급/비밀번호를 모두 입력하세요.'; return; }
  try{
    const j=await jsonp(`${EXEC_URL}?action=key&schoolId=${encodeURIComponent(school)}&classId=${encodeURIComponent(klass)}&code=${encodeURIComponent(code)}`);
    if(j&&j.ok&&j.teacherKey){
      localStorage.setItem('tk', j.teacherKey);
      localStorage.setItem('schoolId', school);
      localStorage.setItem('classId', klass);
      $('bindMsg').textContent='연결 완료';
      refresh(); loadRoster();
    }else{
      $('bindMsg').textContent='실패: '+(j&&j.error||'');
    }
  }catch(e){ $('bindMsg').textContent='네트워크 오류'; }
}
async function loadRoster(){
  const k=tk(); if(!k){ $('rosterMsg').textContent='미연결'; return; }
  $('rosterMsg').textContent='불러오는 중…';
  try{
    const j=await jsonp(`${EXEC_URL}?action=resolveKey&key=${encodeURIComponent(k)}`);
    if(j&&j.roster){ $('roster').value=j.roster.join('\n'); $('rosterMsg').textContent='완료'; }
    else{ $('rosterMsg').textContent='명단 없음'; }
  }catch(e){ $('rosterMsg').textContent='네트워크 오류'; }
}
async function saveRoster(){
  const k=tk(); if(!k){ $('rosterMsg').textContent='미연결'; return; }
  const roster=$('roster').value.trim(); if(!roster){ $('rosterMsg').textContent='명단이 비어있습니다.'; return; }
  $('rosterMsg').textContent='저장 중…';
  const school=(localStorage.getItem('schoolId')||'').trim(), klass=(localStorage.getItem('classId')||'').trim();
  try{
    const j=await jsonp(`${EXEC_URL}?action=saveRoster&key=${encodeURIComponent(k)}&schoolId=${encodeURIComponent(school)}&classId=${encodeURIComponent(klass)}&roster=${encodeURIComponent(roster)}`);
    $('rosterMsg').textContent = (j&&j.ok)?'저장 완료':('실패: '+(j&&j.error||'')); 
  }catch(e){ $('rosterMsg').textContent='네트워크 오류'; }
}
async function changePw(){
  const k=tk(); if(!k){ $('pwMsg').textContent='미연결'; return; }
  const o=$('oldPw').value.trim(), n=$('newPw').value.trim();
  if(!o||!n){ $('pwMsg').textContent='입력 누락'; return; }
  $('pwMsg').textContent='변경 중…';
  try{
    const j=await jsonp(`${EXEC_URL}?action=changeTeacherCode&key=${encodeURIComponent(k)}&old=${encodeURIComponent(o)}&new=${encodeURIComponent(n)}`);
    $('pwMsg').textContent = (j&&j.ok)?'변경 완료':('실패: '+(j&&j.error||'')); 
  }catch(e){ $('pwMsg').textContent='네트워크 오류'; }
}
async function setPC(){
  const k=tk(); if(!k){ $('pcMsg').textContent='미연결'; return; }
  const pc=$('parentCode').value.trim(); if(!pc){ $('pcMsg').textContent='공용코드를 입력하세요.'; return; }
  $('pcMsg').textContent='저장 중…';
  try{
    const j=await jsonp(`${EXEC_URL}?action=setParentCode&key=${encodeURIComponent(k)}&parentCode=${encodeURIComponent(pc)}`);
    $('pcMsg').textContent = (j&&j.ok)?'저장 완료':'실패';
  }catch(e){ $('pcMsg').textContent='네트워크 오류'; }
}
function unbind(){
  if(!confirm('이 기기의 로그인 정보(tk)와 설정을 삭제합니다. 계속할까요?')) return;
  ['tk','schoolId','classId'].forEach(k=>localStorage.removeItem(k));
  refresh(); $('wipeMsg').textContent='이 기기에서 로그아웃되었습니다.';
}
async function wipeAll(){
  const k=tk(); if(!k){ $('wipeMsg').textContent='미연결'; return; }
  if(!confirm('서버의 학급 데이터까지 모두 삭제합니다. 되돌릴 수 없습니다. 계속할까요?')) return;
  if(!confirm('정말로 삭제하시겠습니까?')) return;
  $('wipeMsg').textContent='삭제 중…';
  try{
    const j=await jsonp(`${EXEC_URL}?action=wipeAll&key=${encodeURIComponent(k)}`);
    if(j&&j.ok){
      ['tk','schoolId','classId'].forEach(k=>localStorage.removeItem(k));
      $('wipeMsg').textContent='모든 데이터가 삭제되었습니다.';
      refresh();
    }else{
      $('wipeMsg').textContent='실패: '+(j&&j.error||'');
    }
  }catch(e){ $('wipeMsg').textContent='네트워크 오류'; }
}

// 이벤트 바인딩
$('btnBind').onclick=bindNow;
$('btnLoadRoster').onclick=loadRoster;
$('btnSaveRoster').onclick=saveRoster;
$('btnChgPw').onclick=changePw;
$('btnSetPC').onclick=setPC;
$('btnUnbind').onclick=unbind;
$('btnWipe').onclick=wipeAll;

// 초기
refresh();
if(tk()) loadRoster();
</script>
</body>
</html>
