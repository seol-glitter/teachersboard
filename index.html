<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>대시보드 · 불의 마법을 푸는 안전 열쇠</title>
<style>
:root{--bg-top:#cfe9fb;--bg-bottom:#fff;--ink:#0b2a4a;--accent:#0f2f57;--pill:#0d2744;--card:#f6fbff;--line:#d7e7f5}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);
     background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom))}
.wrap{max-width:1150px;margin:0 auto;padding:18px 12px 40px}
.banner{display:block;width:100%;max-width:980px;margin:0 auto}
.topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 8px;flex-wrap:wrap}
.btn{padding:10px 14px;border:0;border-radius:12px;background:var(--pill);color:#fff;font-weight:800;cursor:pointer}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 8px 30px rgba(13,39,68,.06);margin-top:10px}
.note{font-size:12px;opacity:.8}
.hint{font-size:12px;margin:6px 0 10px;color:#0f2f57}
table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
th,td{padding:8px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top}
th{background:#f1f8ff;text-align:center;user-select:none;cursor:pointer}
th:first-child, td:first-child{width:48px;text-align:center}
th:nth-child(2), td:nth-child(2){min-width:140px}
td .cell{display:flex;flex-direction:column;align-items:center;gap:6px}
.thumb{width:90px;height:90px;background:#f5f7fa;border:1px solid #e3eef6;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.thumb img{max-width:100%;max-height:100%;display:block}
.date{font-size:11px;opacity:.8}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-weight:700;background:#eaf6ef;color:#177a4c}
.badge.off{background:#f8ecec;color:#9f1c1c}
.filterHint{margin-left:8px;font-size:12px;opacity:.7}
.rowName{color:#0f2f57;text-decoration:underline;cursor:pointer}
.hidden{display:none}
details.panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 10px}
details.panel summary{font-weight:800;cursor:pointer;outline:none}
textarea#rosterBox{width:100%;min-height:140px;margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.btn-secondary{background:#6b7b8c}
.ok{color:#0a7a3d}
.err{color:#9f1c1c}
.debug{position:fixed;right:10px;bottom:10px;background:#0b2a4a;color:#eaffff;border-radius:10px;padding:8px 10px;font-size:12px}
.debug b{font-weight:900}
.debug button{margin-left:6px;background:#225;box-shadow:none;padding:6px 8px;border-radius:8px;color:#eaffff}
</style>
<body>
  <div class="debug">
    EXEC: <b id="execShow">—</b>
    <button id="setExecBtn">서버 설정</button>
    <button id="pingBtn">핑</button>
  </div>

  <div class="wrap">
    <img class="banner" src="https://seol-glitter.github.io/teacherhome/banner.png" alt="">
    <div class="topbar">
      <div>
        <div id="klass" class="note"></div>
      </div>
      <div>
        <button id="btnProbe" class="btn" type="button" title="서버에서 현재 저장된 명단을 읽어 확인">서버 점검</button>
      </div>
    </div>

    <details class="panel" id="panelRoster" open>
      <summary>유아 명단 입력/수정 (선택 사항)</summary>
      <div class="note">명단은 <b>선택 사항</b>입니다. 한 줄에 한 명(엔터) 또는 쉼표(,)로 구분. (명단 없이도 사용 가능)</div>
      <textarea id="rosterBox" placeholder="예)
민준
서윤
지호
하린"></textarea>
      <div class="row">
        <button class="btn" id="saveBtn" type="button">저장</button>
        <button class="btn btn-secondary" id="closeBtn" type="button">접기</button>
        <div id="saveMsg" class="note" aria-live="polite"></div>
      </div>
    </details>

    <p class="hint">※ 유아 <b>명단은 선택 사항</b>입니다. <b>명단을 작성하지 않아도</b> 모든 기능을 이용할 수 있어요. (이름을 선택하면 교사가 확인하기 더 쉬워요)</p>

    <div class="card">
      <h3 style="margin:6px 0 10px">진행 현황 <span id="filterState" class="filterHint"></span></h3>
      <div class="note" id="updated"></div>
      <div style="overflow-x:auto;margin-top:8px">
        <table id="tbl">
          <thead>
            <tr>
              <th data-col="idx">No</th>
              <th data-col="child">유아명</th>
              <th data-col="02_위험찾기">2) 위험찾기</th>
              <th data-col="03_화재대피안전수칙">3) 대피수칙</th>
              <th data-col="04_비상구로대피">4) 비상구</th>
              <th data-col="05_옷에불이붙었어요">5) 옷에 불</th>
              <th data-col="06_119신고하기">6) 119</th>
              <th data-col="07_소화기사용법">7) 소화기</th>
              <th data-col="08_완강기사용법">8) 완강기</th>
              <th data-col="sum">합계</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note" style="margin-top:10px">
        개인정보 안내: 본 사이트에 저장된 개인정보는 <b>매 학년도 종료 후 담임이 직접 파기</b>해야 하며, <b>탈퇴 시 자동 삭제</b>됩니다.
      </div>
    </div>
  </div>

<script>
// ===== EXEC/TK 세팅 =====
const qp = new URLSearchParams(location.search);
const tk = qp.get('tk') || '';
const execFromQuery = qp.get('exec');
if (execFromQuery) localStorage.setItem('EXEC', execFromQuery);
const EXEC = localStorage.getItem('EXEC') || 'https://script.google.com/macros/s/___EXEC_ID___/exec'; // 최초 1회 설정
document.getElementById('execShow').textContent = EXEC;
if(!tk){ document.body.innerHTML='<p style="padding:20px">키가 없습니다. 교사용 홈에서 다시 들어오세요.</p>'; throw new Error('no tk'); }

// ===== 도구 =====
const $=id=>document.getElementById(id);
function jsonp(url,timeoutMs=12000){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    window[cb]=(d)=>{cleanup();resolve(d)};
    function cleanup(){try{delete window[cb]}catch(_){}
      if(s&&s.parentNode)s.parentNode.removeChild(s); if(t)clearTimeout(t);}
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_v='+(Date.now());
    s.onerror=()=>{cleanup();reject(new Error('JSONP failed'))};
    document.body.appendChild(s);
    const t=setTimeout(()=>{cleanup();reject(new Error('Timeout'))},timeoutMs);
  });
}

// ===== 상태 =====
let SCHOOL='', CLASS='', ROSTER=[], GRID={};
const PROBLEMS=["02_위험찾기","03_화재대피안전수칙","04_비상구로대피","05_옷에불이붙었어요","06_119신고하기","07_소화기사용법","08_완강기사용법"];

// ===== EXEC 설정/핑 =====
$('setExecBtn').onclick=()=>{
  const v = prompt('Apps Script 웹앱 /exec URL을 붙여넣으세요', localStorage.getItem('EXEC')||'');
  if(!v) return;
  localStorage.setItem('EXEC', v.trim());
  location.href = location.pathname+'?tk='+encodeURIComponent(tk)+'&v='+Date.now(); // 새고
};
$('pingBtn').onclick=async()=>{
  try{ const r=await jsonp(`${EXEC}?action=ping`); alert('서버 응답: '+JSON.stringify(r)); }
  catch(e){ alert('핑 실패: '+e.message); }
};

// ===== 데이터 로드/표시 =====
async function loadData(){
  const info=await jsonp(`${EXEC}?action=resolveKey&key=${encodeURIComponent(tk)}`);
  if(!info || !info.ok){ $('klass').textContent='서버 오류'; return; }
  SCHOOL=info.schoolId||''; CLASS=info.classId||''; ROSTER=Array.isArray(info.roster)?info.roster:[];
  $('klass').textContent = `기관: ${SCHOOL||'(미설정)'} · 반: ${CLASS||'(미설정)'}`;

  const lb=await jsonp(`${EXEC}?action=listByChild&key=${encodeURIComponent(tk)}`);
  GRID={}; (lb.items||[]).forEach(it=>{
    const child=(it.child||'').trim();
    if(!GRID[child]) GRID[child]={};
    GRID[child][it.problem]={fid:it.fileId, ts:it.ts};
  });

  renderTable();
}

function renderTable(){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  const names = Array.from(ROSTER);
  const others = Object.keys(GRID).filter(n=> n && !names.includes(n));
  const rows = names.concat(others).map((name, i)=>({name, idx:i+1}));
  const hasUnknown = GRID[''] && Object.keys(GRID['']).length>0;
  if(hasUnknown) rows.push({name:'(이름 미선택)', idx:rows.length+1, unknown:true});

  rows.forEach(row=>{
    const tr=document.createElement('tr'); tr.dataset.child=row.name;
    const tdNo=document.createElement('td'); tdNo.textContent=row.idx; tr.appendChild(tdNo);
    const tdName=document.createElement('td');
    const a=document.createElement('a'); a.textContent=row.name||''; a.className='rowName';
    a.onclick=()=>toggleChildFilter(row.name);
    tdName.appendChild(a); tr.appendChild(tdName);

    let sum=0;
    PROBLEMS.forEach(p=>{
      const td=document.createElement('td'); td.dataset.problem=p;
      const cell=document.createElement('div'); cell.className='cell';
      const thumb=document.createElement('div'); thumb.className='thumb';
      const date=document.createElement('div'); date.className='date';

      const rec=(GRID[row.unknown?'':row.name]||{})[p];
      if(rec){
        sum++;
        const img=document.createElement('img'); img.alt=p; img.loading='lazy';
        thumb.appendChild(img);
        thumb.title='클릭하여 미리보기 로드'; thumb.style.cursor='pointer';
        thumb.onclick=async ()=>{
          if(img.src) return;
          const j=await jsonp(`${EXEC}?action=thumbB64&key=${encodeURIComponent(tk)}&fileId=${encodeURIComponent(rec.fid)}`);
          if(j.ok){ img.src=`data:${j.mime};base64,${j.b64}`; thumb.title=''; }
        };
        date.textContent=new Date(rec.ts).toLocaleDateString();
      }else{
        thumb.innerHTML='<span class="badge off">—</span>'; date.textContent='';
      }
      cell.appendChild(thumb); cell.appendChild(date); td.appendChild(cell); tr.appendChild(td);
    });
    const tdSum=document.createElement('td'); tdSum.innerHTML=`<span class="badge">${sum}</span>`; tr.appendChild(tdSum);
    tb.appendChild(tr);
  });

  $('updated').textContent='썸네일은 클릭 시 로드됩니다.';
}

// ===== 필터 =====
let activeChild='', activeProblem='';
function clearFilters(){
  activeChild=''; activeProblem='';
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>tr.classList.remove('hidden'));
  $('filterState').textContent='';
}
function toggleChildFilter(name){
  if(activeChild===name){ clearFilters(); return; }
  activeChild=name; activeProblem='';
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    tr.classList.toggle('hidden', tr.dataset.child!==name);
  });
  $('filterState').textContent=`유아 필터: ${name||'(이름 미선택)'}`;
}

// ===== 명단 저장 =====
$('closeBtn').addEventListener('click', ()=>{ $('panelRoster').open=false; });

$('saveBtn').addEventListener('click', async ()=>{
  $('saveBtn').disabled = true;
  $('saveMsg').textContent='저장 중…';
  const rosterText = $('rosterBox').value || '';
  try{
    const url = `${EXEC}?action=saveRoster&key=${encodeURIComponent(tk)}&schoolId=${encodeURIComponent(SCHOOL)}&classId=${encodeURIComponent(CLASS)}&roster=${encodeURIComponent(rosterText)}`;
    const j = await jsonp(url);

    // ⛑️ 구버전 응답 가드: roster 배열 없으면 재조회 금지(초기화 방지)
    if (!j || !j.ok || !Array.isArray(j.roster)) {
      $('saveMsg').innerHTML='<span class="err">서버 코드가 구버전입니다. Apps Script에서 "웹앱 배포 → 연필(이 배포 업데이트)"로 최신 코드(R6+)를 같은 URL에 올려주세요.</span>';
      return;
    }

    // ① UI 즉시 반영
    ROSTER = j.roster.slice();
    $('rosterBox').value = ROSTER.join('\n');
    renderTable();

    // ② 서버 재조회(최종 확인)
    await loadData();

    $('saveMsg').innerHTML='<span class="ok">저장 완료!</span>';
    setTimeout(()=>{ $('panelRoster').open=false; $('saveMsg').textContent=''; }, 600);
  }catch(err){
    $('saveMsg').innerHTML='<span class="err">오류: '+err.message+'</span>';
  }finally{
    $('saveBtn').disabled = false;
  }
});

// 서버 점검: 서버 저장된 명단 수 즉시 확인
$('btnProbe').addEventListener('click', async ()=>{
  try{
    const info=await jsonp(`${EXEC}?action=resolveKey&key=${encodeURIComponent(tk)}`);
    alert('서버 저장된 명단 수: '+(info && info.roster ? info.roster.length : 0));
  }catch(e){ alert('서버 점검 실패: '+e.message); }
});

// 시작
window.addEventListener('DOMContentLoaded', async ()=>{
  // 홈에서 exec= 넘어오면 저장됨. 핑으로 버전 확인(선택)
  try{ const ping=await jsonp(`${EXEC}?action=ping`); console.log('ping', ping); }catch(_){}
  await loadData();
});
</script>
</body>
</html>
