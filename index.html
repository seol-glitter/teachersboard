<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교사용 대시보드</title>
<style>
:root{ --bg:#eaf6ff; --card:#fff; --ink:#0f172a; --sub:#334155; --pri:#0ea5e9; --priD:#0284c7; --warn:#ef4444; }
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:1000px;margin:0 auto;padding:18px}
h1{margin:0 0 10px}
.badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#e2fbe8;color:#065f46;font-weight:800;font-size:12px}
.badge.off{background:#fee2e2;color:#991b1b}
.card{background:var(--card);border:1px solid #d7e7f5;border-radius:16px;padding:16px;margin:10px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.row>*{flex:1}
input,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:12px}
textarea{min-height:160px}
.btn{padding:10px 14px;border:0;border-radius:12px;background:var(--pri);color:#fff;font-weight:800;cursor:pointer}
.btn:hover{background:var(--priD)}
.btn.sec{background:#475569}
.btn.warn{background:var(--warn)}
.note{font-size:12px;color:var(--sub);margin-top:6px}
.hide{display:none}
.grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
.thumb{background:#0f172a;border-radius:12px;overflow:hidden;color:#fff}
.thumb img{display:block;width:100%;height:140px;object-fit:cover}
.caption{padding:8px;font-size:12px}
.diag{font-size:12px;color:#991b1b;white-space:pre-wrap}
</style>
<body>
<div class="wrap">
  <h1>교사용 대시보드 <span id="bindState" class="badge">확인 중…</span></h1>

  <div class="card" id="rebindCard">
    <h3>로그인(기관/학급/비밀번호)</h3>
    <div class="row">
      <input id="school" placeholder="기관명">
      <input id="klass"  placeholder="학급명">
      <input id="tcode"  type="password" placeholder="교사용 비밀번호">
    </div>
    <div class="row">
      <button class="btn" id="btnBind">로그인 & 연결</button>
      <button class="btn sec" id="btnPing">진단(핑)</button>
    </div>
    <div class="note" id="bindMsg"></div>
    <div class="diag" id="diag"></div>
    <div class="note" id="authHelp" style="display:none">
      비밀번호가 맞지 않아요. 같은 이름의 학급이 잠겨 있으면 <b>새 학급명으로 재가입</b> 해주세요.
    </div>
  </div>

  <div id="main" class="hide">
    <div class="note">모드: <b id="vMode"></b></div>

    <div class="card">
      <h3>유아 명단(선택)</h3>
      <textarea id="roster" placeholder="한 줄에 한 명 (선택 사항)"></textarea>
      <div class="row">
        <button class="btn" id="btnSaveRoster">유아명 저장</button>
        <button class="btn sec" id="btnLoadRoster">불러오기</button>
      </div>
      <div class="note">* 유아명단이 없어도 촬영/업로드는 가능합니다.</div>
      <div class="note" id="rosterMsg"></div>
    </div>

    <div class="card">
      <h3>유아 성취(최신)</h3>
      <div id="grid" class="grid"></div>
      <div class="note" id="achMsg"></div>
    </div>

    <div class="card">
      <h3>학부모 공용코드</h3>
      <div class="row">
        <input id="parentCode" placeholder="예: FIRE12">
        <button class="btn" id="btnSetPC">저장</button>
      </div>
      <div class="note">학부모에게 이 코드를 안내하면 <b>자녀 성취 열람</b>이 가능합니다. (코드 = 공용코드 + 2자리 유아번호, 예: FIRE12<strong>07</strong>)</div>
      <div class="note" id="pcMsg"></div>
    </div>

    <div class="card">
      <h3>교사용 비밀번호 변경</h3>
      <div class="row">
        <input id="oldPw" type="password" placeholder="현재 비밀번호">
        <input id="newPw" type="password" placeholder="새 비밀번호">
        <button class="btn" id="btnChgPw">변경</button>
      </div>
      <div class="note" id="pwMsg"></div>
    </div>

    <div class="card">
      <h3>기기 초기화</h3>
      <div class="row">
        <button class="btn warn" id="btnUnbind">기기 연결 해제 (초기화)</button>
      </div>
      <div class="note">이 기기에 저장된 연결정보를 삭제하고 손님모드로 전환합니다. 전임자 비밀번호 없이도 새로 가입 가능합니다.</div>
    </div>
  </div>
</div>

<script>
// === GAS URL & 모드 ===
const EXEC_A = "https://script.google.com/macros/s/AKfycby4camh7UDnlV4ElL3eJPUUWvslSAtfyssAQBRfizcY9D1MRJK9r_O0ZYDnQvKryalG/exec";
const EXEC_B = "https://script.google.com/macros/s/AKfycbzNUWjOhh3V-Cu2WYkl6voDKoAHFKjOl_OQbKH6rQYj6o8K06YoQmc0D7Q6WMJJ-Foz/exec";
const qs=new URLSearchParams(location.search);
const mode=(qs.get('mode')||localStorage.getItem('mode')||'b').toLowerCase()==='a'?'a':'b';
localStorage.setItem('mode',mode);
const EXEC=(mode==='a')?EXEC_A:EXEC_B;

const $=id=>document.getElementById(id);
function jsonp(url, timeoutMs=8000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    let done=false; const timer=setTimeout(()=>{ if(done) return; done=true; cleanup(); rej(new Error('timeout')); }, timeoutMs);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(timer); }
    window[cb]=(data)=>{ if(done) return; done=true; cleanup(); res(data); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    s.onerror=()=>{ if(done) return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}
function setBind(on){ const b=$('bindState'); if(on){b.textContent='연결됨';b.classList.remove('off')} else{b.textContent='손님모드';b.classList.add('off')} }
function refreshUI(){
  const tk=(localStorage.getItem('tk')||'').trim();
  const on=!!tk; setBind(on);
  $('rebindCard').classList.toggle('hide', on);
  $('main').classList.toggle('hide', !on);
  $('vMode').textContent=(mode==='a'?'A모드':'B모드');
  return on;
}
$('btnPing').onclick=async()=>{ try{ const j=await jsonp(EXEC+'?action=ping'); $('diag').textContent=(j&&j.ok)?'핑 OK':'응답 비정상'; }catch(e){ $('diag').textContent='핑 실패(배포/권한 확인)'; } };

$('btnBind').onclick=async()=>{
  const s=$('school').value.trim(), k=$('klass').value.trim(), c=$('tcode').value.trim();
  if(!s||!k||!c){ $('bindMsg').textContent='기관/학급/비밀번호를 모두 입력해주세요'; return; }
  $('bindMsg').textContent='연결 중…';
  try{
    const j=await jsonp(EXEC+'?'+new URLSearchParams({action:'key',schoolId:s,classId:k,code:c}));
    if(j&&j.ok&&j.teacherKey){
      localStorage.setItem('tk', j.teacherKey);
      localStorage.setItem('schoolId', s);
      localStorage.setItem('classId', k);
      $('bindMsg').textContent='연결 성공'; $('authHelp').style.display='none';
      refreshUI(); loadRoster(); loadAchievements();
    }else{
      const err=(j&&j.error)||'';
      $('bindMsg').textContent = (err==='auth') ? '비밀번호가 일치하지 않습니다.' : ('실패: '+err);
      if(err==='auth') $('authHelp').style.display='';
    }
  }catch(e){ $('bindMsg').textContent='네트워크 오류/타임아웃'; }
};

$('btnUnbind').onclick=()=>{
  if(!confirm('이 기기의 연결정보를 삭제하고 손님모드로 전환합니다. 진행할까요?')) return;
  ['tk','schoolId','classId','faceDB'].forEach(k=>localStorage.removeItem(k));
  alert('초기화되었습니다. 새로 가입하여 사용하실 수 있습니다.');
  refreshUI();
};

async function loadRoster(){
  $('rosterMsg').textContent='불러오는 중…';
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('rosterMsg').textContent='손님모드'; return; }
  try{
    const j=await jsonp(EXEC+'?action=resolveKey&key='+encodeURIComponent(tk));
    if(j&&Array.isArray(j.roster)){ $('roster').value=j.roster.join('\n'); $('rosterMsg').textContent='완료'; }
    else{ $('roster').value=''; $('rosterMsg').textContent='명단 없음(선택 사항)'; }
  }catch(e){ $('rosterMsg').textContent='네트워크 오류/타임아웃'; }
}
async function saveRoster(){
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('rosterMsg').textContent='손님모드'; return; }
  const roster=$('roster').value.trim(); $('rosterMsg').textContent='저장 중…';
  try{
    const j=await jsonp(EXEC+'?'+new URLSearchParams({action:'saveRoster',key:tk,roster}));
    $('rosterMsg').textContent=(j&&j.ok)?'저장 완료':('실패: '+((j&&j.error)||'')); if(j&&j.ok) loadAchievements();
  }catch(e){ $('rosterMsg').textContent='네트워크 오류/타임아웃'; }
}
async function loadAchievements(){
  const tk=(localStorage.getItem('tk')||'').trim(); if(!tk){ $('achMsg').textContent='손님모드'; return; }
  $('achMsg').textContent='불러오는 중…'; $('grid').innerHTML='';
  try{
    const j=await jsonp(EXEC+'?action=listByChild&key='+encodeURIComponent(tk));
    if(!(j&&j.ok)){ $('achMsg').textContent='불러오기 실패'; return; }
    const items=j.items||[]; const grid=$('grid'); grid.innerHTML='';
    for(const it of items){
      const card=document.createElement('div'); card.className='thumb';
      const img=document.createElement('img'); img.alt=it.problem;
      try{
        const t=await jsonp(EXEC+'?action=thumbB64&fileId='+encodeURIComponent(it.fileId));
        if(t&&t.ok&&t.b64) img.src=`data:${t.mime||'image/jpeg'};base64,${t.b64}`; else{ img.alt='(이미지 없음)'; img.style.height='140px'; }
      }catch(_){ img.alt='(로드 실패)'; img.style.height='140px'; }
      const cap=document.createElement('div'); cap.className='caption'; cap.textContent=`${it.child||'(미지정)'} · ${it.problem}`;
      card.appendChild(img); card.appendChild(cap); grid.appendChild(card);
    }
    $('achMsg').textContent = items.length? '': '표시할 항목이 없습니다.';
  }catch(e){ $('achMsg').textContent='네트워크 오류/타임아웃'; }
}
$('btnLoadRoster').onclick=loadRoster;
$('btnSaveRoster').onclick=saveRoster;

if(refreshUI()){ loadRoster(); loadAchievements(); }
</script>
</body>
</html>
