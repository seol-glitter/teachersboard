<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>대시보드 · 불의 마법을 푸는 안전 열쇠</title>
<style>
:root{--bg-top:#cfe9fb;--bg-bottom:#fff;--ink:#0b2a4a;--accent:#0f2f57;--pill:#0d2744;--card:#f6fbff;--line:#d7e7f5}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;color:var(--ink);
     background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom))}
.wrap{max-width:1150px;margin:0 auto;padding:18px 12px 40px}
.banner{display:block;width:100%;max-width:980px;margin:0 auto}
.topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 8px;flex-wrap:wrap}
.btn{padding:10px 14px;border:0;border-radius:12px;background:var(--pill);color:#fff;font-weight:800;cursor:pointer}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 8px 30px rgba(13,39,68,.06);margin-top:10px}
.note{font-size:12px;opacity:.75}
.hint{font-size:12px;margin:6px 0 10px;color:#0f2f57}
table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
th,td{padding:8px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top}
th{background:#f1f8ff;text-align:center;user-select:none;cursor:pointer}
th:first-child, td:first-child{width:48px;text-align:center}
th:nth-child(2), td:nth-child(2){min-width:140px}
td .cell{display:flex;flex-direction:column;align-items:center;gap:6px}
.thumb{width:90px;height:90px;background:#f5f7fa;border:1px solid #e3eef6;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.thumb img{max-width:100%;max-height:100%;display:block}
.date{font-size:11px;opacity:.8}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-weight:700;background:#eaf6ef;color:#177a4c}
.badge.off{background:#f8ecec;color:#9f1c1c}
.filterHint{margin-left:8px;font-size:12px;opacity:.7}
.rowName{color:#0f2f57;text-decoration:underline;cursor:pointer}
.hidden{display:none}

/* 인라인 편집 패널 */
details.panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px 12px 10px}
details.panel summary{font-weight:800;cursor:pointer;outline:none}
textarea#rosterBox{width:100%;min-height:140px;margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.btn-secondary{background:#6b7b8c}
.ok{color:#0a7a3d}
.err{color:#9f1c1c}

/* 디버그 박스 */
.debug{background:#0b2a4a;color:#eaffff;border-radius:10px;padding:10px;margin-top:10px;font-size:12px}
.debug code{white-space:pre-wrap;word-break:break-all;color:#d1ffea}
.kv{font-size:12px;opacity:.9}
.kv b{display:inline-block;min-width:56px}
</style>
<body>
  <div class="wrap">
    <img class="banner" src="https://seol-glitter.github.io/teacherhome/banner.png" alt="">
    <div class="topbar">
      <div>
        <div id="klass" class="note"></div>
        <div class="kv"><b>EXEC</b> <span id="execShow"></span></div>
        <div class="kv"><b>TK</b> <span id="tkShow"></span></div>
      </div>
      <div>
        <button id="btnProbe" class="btn" type="button" title="서버에서 현재 저장된 명단을 읽어 확인">서버 점검</button>
      </div>
    </div>

    <!-- 유아 명단 (선택사항) -->
    <details class="panel" id="panelRoster" open>
      <summary>유아 명단 입력/수정 (선택 사항)</summary>
      <div class="note">명단은 <b>선택 사항</b>입니다. 한 줄에 한 명(엔터) 또는 쉼표(,)로 구분. (명단 없이도 사용 가능)</div>
      <textarea id="rosterBox" placeholder="예)
민준
서윤
지호
하린"></textarea>
      <div class="row">
        <button class="btn" id="saveBtn" type="button">저장</button>
        <button class="btn btn-secondary" id="closeBtn" type="button">접기</button>
        <div id="saveMsg" class="note" aria-live="polite"></div>
      </div>
    </details>

    <p class="hint">※ 유아 <b>명단은 선택 사항</b>입니다. <b>명단을 작성하지 않아도</b> 모든 기능을 이용할 수 있어요. (이름을 선택하면 교사가 확인하기 더 쉬워요)</p>

    <div class="card">
      <h3 style="margin:6px 0 10px">진행 현황 <span id="filterState" class="filterHint"></span></h3>
      <div class="note" id="updated"></div>
      <div style="overflow-x:auto;margin-top:8px">
        <table id="tbl">
          <thead>
            <tr>
              <th data-col="idx">No</th>
              <th data-col="child">유아명</th>
              <th data-col="02_위험찾기">2) 위험찾기</th>
              <th data-col="03_화재대피안전수칙">3) 대피수칙</th>
              <th data-col="04_비상구로대피">4) 비상구</th>
              <th data-col="05_옷에불이붙었어요">5) 옷에 불</th>
              <th data-col="06_119신고하기">6) 119</th>
              <th data-col="07_소화기사용법">7) 소화기</th>
              <th data-col="08_완강기사용법">8) 완강기</th>
              <th data-col="sum">합계</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note" style="margin-top:10px">
        개인정보 안내: 본 사이트에 저장된 개인정보는 <b>매 학년도 종료 후 담임이 직접 파기</b>해야 하며, <b>탈퇴 시 자동 삭제</b>됩니다.
      </div>
    </div>

    <div class="debug" id="debugBox" style="display:none">
      <div><b>디버그 로그</b> (<a href="#" id="clearLog" style="color:#b6fff1">clear</a>)</div>
      <code id="log"></code>
    </div>
  </div>

<script>
// ===== 설정 =====
const EXEC="https://script.google.com/macros/s/AKfycbyAbSq8dFnO4PHnX71ni4LVG0zDZcYSBGl2AvrbMdFmBj9iLX-Q4Gl7I9t_wM1oVEGOiA/exec";
const PROBLEMS=["02_위험찾기","03_화재대피안전수칙","04_비상구로대피","05_옷에불이붙었어요","06_119신고하기","07_소화기사용법","08_완강기사용법"];
const qp=new URLSearchParams(location.search); const TK=qp.get('tk');
if(!TK){ document.body.innerHTML='<p style="padding:20px">키가 없습니다. 교사용 홈에서 다시 들어오세요.</p>'; throw new Error('no tk'); }

// ===== 유틸 =====
const $=id=>document.getElementById(id);
function logln(s){ const b=$('debugBox'); b.style.display='block'; $('log').textContent += s+'\n'; }
$('execShow').textContent=EXEC;
$('tkShow').textContent=TK.slice(0,12)+'…';

// JSONP
function jsonp(url,timeoutMs=12000){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    let done=false,t=null;
    window[cb]=(d)=>{ if(done)return; done=true; cleanup(); resolve(d); };
    function cleanup(){ try{ delete window[cb]; }catch(_){} if(s&&s.parentNode) s.parentNode.removeChild(s); if(t) clearTimeout(t); }
    const s=document.createElement('script');
    const sep = url.includes('?') ? '&' : '?';
    s.src=url+sep+'callback='+cb+'&_v='+(Date.now()); // 캐시 방지
    s.onerror=()=>{ if(done)return; done=true; cleanup(); reject(new Error('JSONP failed')); };
    document.body.appendChild(s);
    t=setTimeout(()=>{ if(done)return; done=true; cleanup(); reject(new Error('Timeout')); }, timeoutMs);
  });
}

// ===== 상태 =====
let SCHOOL='', CLASS='', ROSTER=[];  // 표 기본 순서
let GRID={}; // child -> problem -> {fid, ts}

// ===== 데이터 로드 =====
async function loadData(){
  logln('→ resolveKey');
  const info=await jsonp(`${EXEC}?action=resolveKey&key=${encodeURIComponent(TK)}`);
  logln('← resolveKey: '+JSON.stringify(info));
  if(info.ok){ SCHOOL=info.schoolId||'', CLASS=info.classId||'', ROSTER=info.roster||[]; }
  $('klass').textContent = `기관: ${SCHOOL||'(미설정)'} · 반: ${CLASS||'(미설정)'}`;
  $('rosterBox').value = (ROSTER||[]).join('\n');

  const lb = await jsonp(`${EXEC}?action=listByChild&key=${encodeURIComponent(TK)}`);
  logln('← listByChild: '+JSON.stringify(lb));
  GRID={};
  (lb.items||[]).forEach(it=>{
    const child=(it.child||'').trim();
    if(!GRID[child]) GRID[child]={};
    GRID[child][it.problem]={fid:it.fileId, ts:it.ts};
  });

  renderTable();
}

function renderTable(){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  const rows=[];
  const names = Array.from(ROSTER);
  const others = Object.keys(GRID).filter(n=> n && !names.includes(n));
  const hasUnknown = GRID[''] && Object.keys(GRID['']).length>0;
  names.concat(others).forEach((name,idx)=>rows.push({name, idx:idx+1}));
  if(hasUnknown) rows.push({name:'(이름 미선택)', idx:rows.length+1, unknown:true});

  rows.forEach(row=>{
    const tr=document.createElement('tr'); tr.dataset.child=row.name;
    const tdNo=document.createElement('td'); tdNo.textContent=row.idx; tr.appendChild(tdNo);

    const tdName=document.createElement('td');
    const a=document.createElement('a'); a.textContent=row.name||''; a.className='rowName';
    a.onclick=()=>toggleChildFilter(row.name);
    tdName.appendChild(a); tr.appendChild(tdName);

    let sum=0;
    PROBLEMS.forEach(p=>{
      const td=document.createElement('td'); td.dataset.problem=p;
      const cell=document.createElement('div'); cell.className='cell';
      const thumb=document.createElement('div'); thumb.className='thumb';
      const date=document.createElement('div'); date.className='date';

      const rec=(GRID[row.unknown? '': row.name]||{})[p];
      if(rec){
        sum++;
        const img=document.createElement('img'); img.alt=p; img.loading='lazy';
        thumb.appendChild(img);
        thumb.title='클릭하여 미리보기 로드'; thumb.style.cursor='pointer';
        thumb.onclick=async ()=>{
          if(img.src) return;
          const j = await jsonp(`${EXEC}?action=thumbB64&key=${encodeURIComponent(TK)}&fileId=${encodeURIComponent(rec.fid)}`);
          if(j.ok){ img.src=`data:${j.mime};base64,${j.b64}`; thumb.title=''; }
        };
        date.textContent=new Date(rec.ts).toLocaleDateString();
      }else{
        thumb.innerHTML='<span class="badge off">—</span>'; date.textContent='';
      }
      cell.appendChild(thumb); cell.appendChild(date);
      td.appendChild(cell); tr.appendChild(td);
    });

    const tdSum=document.createElement('td'); tdSum.innerHTML=`<span class="badge">${sum}</span>`; tr.appendChild(tdSum);
    tb.appendChild(tr);
  });

  document.querySelectorAll('#tbl thead th[data-col]').forEach(th=>{
    th.onclick=()=>{
      const col=th.dataset.col;
      if(col==='idx'||col==='child'||col==='sum'){ clearFilters(); return; }
      toggleProblemFilter(col);
    };
  });
  $('updated').textContent='썸네일은 클릭 시 로드됩니다. 헤더/이름을 눌러 필터할 수 있어요.';
}

// ===== 필터 =====
let activeChild='', activeProblem='';
function clearFilters(){
  activeChild=''; activeProblem='';
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>tr.classList.remove('hidden'));
  $('filterState').textContent='';
}
function toggleChildFilter(name){
  if(activeChild===name){ clearFilters(); return; }
  activeChild=name; activeProblem='';
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    tr.classList.toggle('hidden', tr.dataset.child!==name);
  });
  $('filterState').textContent=`유아 필터: ${name||'(이름 미선택)'}`;
}
function toggleProblemFilter(prob){
  if(activeProblem===prob){ clearFilters(); return; }
  activeProblem=prob; activeChild='';
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    const rec=(GRID[tr.dataset.child||'']||{})[prob] || (tr.dataset.child===''? (GRID['']||{})[prob] : null);
    tr.classList.toggle('hidden', !rec);
  });
  $('filterState').textContent=`문항 필터: ${prob}`;
}

// ===== 인라인 패널 동작 =====
$('closeBtn').addEventListener('click', ()=>{ $('panelRoster').open=false; });

// 저장: JSONP → UI즉시반영 → 서버재조회
$('saveBtn').addEventListener('click', async ()=>{
  $('saveBtn').disabled = true;
  $('saveMsg').textContent='저장 중…';

  const rosterText = $('rosterBox').value || '';
  try{
    logln('→ saveRoster');
    const url = `${EXEC}?action=saveRoster&key=${encodeURIComponent(TK)}&schoolId=${encodeURIComponent(SCHOOL)}&classId=${encodeURIComponent(CLASS)}&roster=${encodeURIComponent(rosterText)}`;
    const j = await jsonp(url);
    logln('← saveRoster: '+JSON.stringify(j));
    if(!j || !j.ok) throw new Error(j && j.error || 'save failed');

    // ① UI 즉시 반영(서버 재조회 전에 보이도록)
    ROSTER = Array.isArray(j.roster) ? j.roster.slice() : (rosterText.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean));
    $('rosterBox').value = ROSTER.join('\n');
    renderTable();

    // ② 서버 재조회로 최종 확인(불일치시 로그로 보임)
    await loadData();

    $('saveMsg').innerHTML='<span class="ok">저장 완료!</span>';
    setTimeout(()=>{ $('panelRoster').open=false; $('saveMsg').textContent=''; }, 500);
  }catch(err){
    $('saveMsg').innerHTML='<span class="err">오류: '+err.message+'</span>';
  }finally{
    $('saveBtn').disabled = false;
  }
});

// “서버 점검” 버튼: resolveKey 결과 직관 표시
$('btnProbe').addEventListener('click', async ()=>{
  try{
    const info=await jsonp(`${EXEC}?action=resolveKey&key=${encodeURIComponent(TK)}`);
    logln('PROBE resolveKey: '+JSON.stringify(info));
    alert('서버의 저장된 명단 수: '+(info && info.roster ? info.roster.length : 0));
  }catch(e){
    logln('PROBE error: '+e.message);
    alert('서버 점검 실패: '+e.message);
  }
});

// 시작
window.addEventListener('DOMContentLoaded', ()=>{
  $('debugBox').style.display='block';
  $('log').textContent='[DEBUG START]\n';
});
loadData();

// 디버그 clear
$('clearLog').addEventListener('click', (e)=>{ e.preventDefault(); $('log').textContent=''; });
</script>
</body>
</html>
